<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>管理员主菜单</title>
    <!-- Bootstrap 5 CSS（CDN，如需离线请改成本地文件） -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand">电信系统 · 管理员控制台</a>
        <div class="d-flex align-items-center text-white">
            <span class="me-3">欢迎，<strong th:text="${session.admin != null ? session.admin.name : '管理员'}">管理员</strong></span>
            <a class="btn btn-outline-light btn-sm" th:href="@{/login/logout}">登出</a>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <!-- 页面标题 & 操作按钮 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">用户管理</h2>
        <div>
            <button class="btn btn-success me-2" id="addUser">
                <i class="bi bi-person-plus"></i> 添加用户
            </button>
            <button class="btn btn-primary" id="analyzeTraffic">
                <i class="bi bi-graph-up"></i> 分析流量
            </button>
        </div>
    </div>

    <!-- 用户列表卡片 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            用户列表
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-dark">
                    <tr>
                        <th style="width: 80px;">账号</th>
                        <th>姓名</th>
                        <th>电话</th>
                        <th>套餐ID</th>
                        <th>余额</th>
                        <th style="width: 180px;">操作</th>
                    </tr>
                    </thead>
                    <tbody id="userTableBody">
                    <tr th:each="user : ${users}">
                        <td th:text="${user.account}">10001</td>
                        <td th:text="${user.name}" data-field="name">张三</td>
                        <td th:text="${user.phone}" data-field="phone">13800000000</td>
                        <td th:text="${user.packageId}" data-field="packageId">1</td>
                        <td th:text="${user.balance}" data-field="balance">88.00</td>
                        <td>
                            <button class="btn btn-warning btn-sm me-2 edit-btn"
                                    th:data-account="${user.account}">
                                修改
                            </button>
                            <button class="btn btn-danger btn-sm delete-btn"
                                    th:data-account="${user.account}">
                                删除
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 添加用户表单（初始隐藏） -->
    <div class="card shadow-sm mt-3" id="addUserCard" style="display:none;">
        <div class="card-header bg-success text-white">
            添加新用户
        </div>
        <div class="card-body">
            <form id="addUserForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-control" name="name" placeholder="请输入姓名" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">电话</label>
                    <input type="text" class="form-control" name="phone" placeholder="请输入电话" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">套餐ID</label>
                    <input type="number" class="form-control" name="packageId" placeholder="套餐ID" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">余额</label>
                    <input type="number" step="0.01" class="form-control" name="balance" placeholder="余额" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">密码</label>
                    <input type="password" class="form-control" name="password" placeholder="初始密码" required>
                </div>
                <div class="col-12 d-flex justify-content-end mt-2">
                    <button type="submit" class="btn btn-success me-2">提交</button>
                    <button type="button" class="btn btn-secondary" id="cancelAddUser">取消</button>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- 流量统计结果 Modal -->
<div class="modal fade" id="trafficModal" tabindex="-1"
     aria-labelledby="trafficModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="trafficModalLabel">用户流量统计结果</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle" id="trafficTable">
              <thead class="table-dark">
                <tr>
                                    <th>账号</th>
                                    <th>姓名</th>
                                    <th>总在线时长(小时)</th>
                                    <th>最后登录时间</th>
                                    <th>登录次数</th>
                                    <th>活跃等级</th>
                                    <th>余额</th>
                                    <th>套餐ID</th>
                </tr>
              </thead>
              <tbody>
                <!-- JS 动态填充 -->
              </tbody>
            </table>
        </div>
        <label class="form-label mt-3">原始统计数据(JSON)：</label>
        <pre id="trafficRawJson" class="bg-light p-2 small border" style="max-height: 200px; overflow:auto;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 JS（包含 Modal 所需脚本；如需离线请改成本地文件） -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
    const apiPrefix = "/admin";
    // 全局编辑状态：当前正在编辑的行（同一时间只能有一行处于编辑状态）
    let editingRow = null;

    const handleRequest = (url, method, body) => {
        console.log(`[handleRequest] url: ${url}, method: ${method}, body:`, body);
        return fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: body ? JSON.stringify(body) : undefined
        }).then(resp => {
            console.log(`[handleRequest] response status: ${resp.status}`);
            if (!resp.ok) throw new Error("请求失败，状态码：" + resp.status);
            return resp.json().catch(() => ({}));
        });
    };

    // 显示添加用户表单
    document.getElementById("addUser").addEventListener("click", () => {
        console.log("[addUser] 点击添加用户按钮");
        const card = document.getElementById("addUserCard");
        const form = document.getElementById("addUserForm");
        form.reset();
        card.style.display = "block";
        card.scrollIntoView({ behavior: "smooth" });
    });

    // 隐藏添加用户表单
    document.getElementById("cancelAddUser").addEventListener("click", () => {
        console.log("[cancelAddUser] 点击取消添加用户按钮");
        document.getElementById("addUserCard").style.display = "none";
    });

    // 提交新增用户
    document.getElementById("addUserForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const payload = {
            account:null,
            name: formData.get("name"),
            phone: formData.get("phone"),
            packageId: Number(formData.get("packageId")),
            balance: Number(formData.get("balance")),
            password: formData.get("password")
        };
        console.log("[addUserForm] 提交数据：", payload);
        handleRequest(apiPrefix + "/create-user", "POST", payload)
            .then(() => {
                console.log("[addUserForm] 添加用户成功，刷新页面");
                location.reload();
            })
            .catch(err => {
                console.error("[addUserForm] 添加用户失败：", err);
                alert("添加用户失败：" + err.message);
            });
    });

    // 行内编辑：修改 / 保存 + 删除 / 取消
    document.querySelectorAll(".edit-btn").forEach(btn => {
        console.log("[edit-btn] 绑定事件", btn);
        btn.addEventListener("click", function () {
            const tr = btn.closest("tr");
            const deleteBtn = tr.querySelector(".delete-btn");
            console.log("[edit-btn] 点击，当前按钮文本：", btn.textContent.trim());

            if (btn.textContent.trim() === "修改") {
                // 如果已有其他行在编辑中，阻止同时编辑
                if (editingRow && editingRow !== tr) {
                    alert("同时只能编辑一个用户，请先保存或取消当前正在编辑的用户。");
                    return;
                }

                // 变为可编辑
                tr.querySelectorAll("td[data-field]").forEach(td => {
                    const field = td.getAttribute("data-field");
                    const value = td.textContent.trim();
                    let inputType = "text";
                    if (field === "balance" || field === "packageId") inputType = "number";
                    console.log(`[edit-btn] 字段${field}变为可编辑，原值：${value}`);
                    td.innerHTML =
                        `<input class="form-control form-control-sm" name="${field}" type="${inputType}" value="${value}">`;
                });
                btn.textContent = "保存";

                // 标记当前正在编辑的行
                editingRow = tr;

                if (deleteBtn) {
                    deleteBtn.textContent = "取消";
                    deleteBtn.classList.add("btn-secondary");
                    deleteBtn.classList.remove("btn-danger");
                    const newDeleteBtn = deleteBtn.cloneNode(true);
                    newDeleteBtn.addEventListener("click", function () {
                        console.log("[edit-btn] 点击取消，恢复页面");
                        // 取消编辑：直接刷新页面以恢复行的原始显示（简单且可靠）
                        editingRow = null;
                        location.reload();
                    });
                    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
                }
            } else {
                // 保存
                const account = btn.dataset.account;
                const payload = {};
                tr.querySelectorAll("input[name]").forEach(input => {
                    payload[input.name] = input.type === "number"
                        ? Number(input.value)
                        : input.value;
                });
                console.log(`[edit-btn] 保存修改，account: ${account}, payload:`, payload);
                handleRequest(`${apiPrefix}/modify-${account}`, "PUT", payload)
                    .then(() => {
                        console.log("[edit-btn] 修改成功，刷新页面");
                        // 保存成功：重置编辑状态后刷新
                        editingRow = null;
                        location.reload();
                    })
                    .catch(err => {
                        console.error("[edit-btn] 修改失败：", err);
                        alert("修改失败：" + err.message);
                    });
            }
        });
    });

    // 删除用户
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const account = btn.dataset.account;
            console.log(`[delete-btn] 点击删除，account: ${account}`);
            if (!confirm(`确认删除账号 ${account} 吗？`)) return;
            handleRequest(`${apiPrefix}/delete-${account}`, "DELETE")
                .then(() => {
                    console.log("[delete-btn] 删除成功，刷新页面");
                    location.reload();
                })
                .catch(err => {
                    console.error("[delete-btn] 删除失败：", err);
                    alert("删除失败：" + err.message);
                });
        });
    });

    // 分析流量并在 Modal 中展示
    document.getElementById("analyzeTraffic").addEventListener("click", () => {
        console.log("[analyzeTraffic] 点击分析流量按钮");
        fetch("/admin/traffic-stats")
            .then(resp => {
                if (!resp.ok) throw new Error("请求失败，状态码：" + resp.status);
                return resp.json();
            })
            .then(data => {
                console.log("[analyzeTraffic] 返回数据：", data);

                const tbody = document.querySelector("#trafficTable tbody");
                tbody.innerHTML = "";

                // 兼容后端可能返回的不同结构：直接数组、{data: [...]}、或单个对象
                let rows = data;
                if (!Array.isArray(rows)) {
                    if (rows && rows.data && Array.isArray(rows.data)) rows = rows.data;
                    else if (rows && rows.stats && Array.isArray(rows.stats)) rows = rows.stats;
                    else rows = [rows];
                }

                if (Array.isArray(rows) && rows.length > 0) {
                    rows.forEach(item => {
                            console.log("[analyzeTraffic] 处理行数据：", item);
                            const tr = document.createElement("tr");
                            // 后端返回的字段以 getUserActivityStatistics() 为准，映射如下：
                            // accountId, userName, totalOnlineHours, lastLoginTime, loginCount, activityLevel, balance, packageId
                            const account = item.accountId ?? item.account ?? "";
                            const name = item.userName ?? item.name ?? "";
                            const totalHours = item.totalOnlineHours ?? item.totalOnline ?? "";
                            const lastLogin = item.lastLoginTime ?? item.lastActiveTime ?? "";
                            const loginCount = item.loginCount ?? "";
                            const level = item.activityLevel ?? "";
                            const balance = item.balance ?? "";
                            const packageId = item.packageId ?? "";

                            // 格式化时间为本地字符串（如果是 ISO 字符串或可解析）
                            let lastLoginStr = lastLogin;
                            try {
                                if (lastLogin && typeof lastLogin === 'string') {
                                    const dt = new Date(lastLogin);
                                    if (!isNaN(dt)) lastLoginStr = dt.toLocaleString();
                                } else if (lastLogin && typeof lastLogin === 'object' && lastLogin.toString) {
                                    // 如果是序列化的 LocalDateTime，也尝试转换
                                    lastLoginStr = lastLogin.toString();
                                }
                            } catch (e) {
                                // ignore
                            }

                            tr.innerHTML = `
                                <td>${account}</td>
                                <td>${name}</td>
                                <td>${totalHours}</td>
                                <td>${lastLoginStr}</td>
                                <td>${loginCount}</td>
                                <td>${level}</td>
                                <td>${balance}</td>
                                <td>${packageId}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                } else {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td colspan="8" class="text-center">暂无统计数据</td>`;
                    tbody.appendChild(tr);
                }

                const raw = document.getElementById("trafficRawJson");
                raw.textContent = JSON.stringify(data, null, 2);

                const modalEl = document.getElementById("trafficModal");
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            })
            .catch(err => {
                console.error("[analyzeTraffic] 流量分析接口不可用", err);
                alert("流量分析接口暂不可用：" + err.message);
            });
    });
})();
</script>

</body>
</html>